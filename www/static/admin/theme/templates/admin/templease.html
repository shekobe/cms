<!DOCTYPE html>
<!-- 
Template Name: Metronic - Responsive Admin Dashboard Template build with Twitter Bootstrap 3.3.4
Version: 3.9.0
Author: KeenThemes
Website: http://www.keenthemes.com/
Contact: support@keenthemes.com
Follow: www.twitter.com/keenthemes
Like: www.facebook.com/keenthemes
Purchase: http://themeforest.net/item/metronic-responsive-admin-dashboard-template/4021469?ref=keenthemes
License: You must have a valid license purchased only from themeforest(the above link) in order to legally use the theme for your project.
-->
<!--[if IE 8]>
<html lang="en" class="ie8 no-js"> <![endif]-->
<!--[if IE 9]>
<html lang="en" class="ie9 no-js"> <![endif]-->
<!--[if !IE]><!-->
<html lang="en">
    <!--<![endif]-->
    <!-- BEGIN HEAD -->
    <head>
        <meta charset="utf-8"/>
        <title>Metronic | Data Tables - Editable Datatables</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8">
        <meta content="" name="description"/>
        <meta content="" name="author"/>
        <!-- BEGIN GLOBAL MANDATORY STYLES -->
        <!--<link href="http://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700&subset=all" rel="stylesheet" type="text/css"/>-->
        <link href="../../assets/global/plugins/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
        <link href="../../assets/global/plugins/simple-line-icons/simple-line-icons.min.css" rel="stylesheet" type="text/css"/>
        <link href="../../assets/global/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
        <link href="../../assets/global/plugins/uniform/css/uniform.default.css" rel="stylesheet" type="text/css"/>
        <link href="../../assets/global/plugins/bootstrap-switch/css/bootstrap-switch.min.css" rel="stylesheet" type="text/css"/>
        <!-- END GLOBAL MANDATORY STYLES -->
        <!-- BEGIN PAGE LEVEL STYLES -->
        <link rel="stylesheet" type="text/css" href="../../assets/global/plugins/select2/select2.css"/>
        <link rel="stylesheet" type="text/css" href="../../assets/global/plugins/datatables/plugins/bootstrap/dataTables.bootstrap.css"/>
        <!-- END PAGE LEVEL STYLES -->
        <!-- BEGIN PAGE LEVEL STYLES -->
        <link href="../../assets/global/plugins/bootstrap-modal/css/bootstrap-modal-bs3patch.css" rel="stylesheet" type="text/css"/>
        <link href="../../assets/global/plugins/bootstrap-modal/css/bootstrap-modal.css" rel="stylesheet" type="text/css"/>
        <!-- END PAGE LEVEL STYLES -->
        <!-- BEGIN THEME STYLES -->
        <link href="../../assets/global/css/components.css" id="style_components" rel="stylesheet" type="text/css"/>
        <link href="../../assets/global/css/plugins.css" rel="stylesheet" type="text/css"/>
        <link href="../../assets/admin/layout/css/layout.css" rel="stylesheet" type="text/css"/>
        <link id="style_color" href="../../assets/admin/layout/css/themes/darkblue.css" rel="stylesheet" type="text/css"/>
        <link href="../../assets/admin/layout/css/custom.css" rel="stylesheet" type="text/css"/>
        <!-- END THEME STYLES -->
        <link rel="shortcut icon" href="favicon.ico"/>
        <script src="../../assets/admin/layout/scripts/socket.io.js"></script>
    </head>
    <!-- END HEAD -->
    <!-- BEGIN BODY -->
    <!-- DOC: Apply "page-header-fixed-mobile" and "page-footer-fixed-mobile" class to body element to force fixed header or footer in mobile devices -->
    <!-- DOC: Apply "page-sidebar-closed" class to the body and "page-sidebar-menu-closed" class to the sidebar menu element to hide the sidebar by default -->
    <!-- DOC: Apply "page-sidebar-hide" class to the body to make the sidebar completely hidden on toggle -->
    <!-- DOC: Apply "page-sidebar-closed-hide-logo" class to the body element to make the logo hidden on sidebar toggle -->
    <!-- DOC: Apply "page-sidebar-hide" class to body element to completely hide the sidebar on sidebar toggle -->
    <!-- DOC: Apply "page-sidebar-fixed" class to have fixed sidebar -->
    <!-- DOC: Apply "page-footer-fixed" class to the body element to have fixed footer -->
    <!-- DOC: Apply "page-sidebar-reversed" class to put the sidebar on the right side -->
    <!-- DOC: Apply "page-full-width" class to the body element to have full width page without the sidebar menu -->
    <body class="page-header-fixed page-quick-sidebar-over-content " style="background-color: #fff;">

        <div class="clearfix">
        </div>
        <!-- BEGIN CONTAINER -->
        <div class="">

            <!-- BEGIN CONTENT -->
            <div class="page-content-wrapper">
                <div>
                    <!-- BEGIN SAMPLE PORTLET CONFIGURATION MODAL FORM-->
                    <div class="modal fade" id="portlet-config" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                                    <h4 class="modal-title">Modal title</h4>
                                </div>
                                <div class="modal-body">
                                    Widget settings form goes here
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn blue">Save changes</button>
                                    <button type="button" class="btn default" data-dismiss="modal">Close</button>
                                </div>
                            </div>
                            <!-- /.modal-content -->
                        </div>
                        <!-- /.modal-dialog -->
                    </div>
                    <!-- /.modal -->
                    <!-- END SAMPLE PORTLET CONFIGURATION MODAL FORM-->


                    <!-- BEGIN PAGE CONTENT-->
                    <div class="row">
                        <div class="col-md-12">
                            <!-- BEGIN EXAMPLE TABLE PORTLET-->
                            <div class="portlet box blue">
                                <div class="portlet-title">
                                    <div class="caption">
                                        <i class="fa fa-edit"></i>模板设置
                                    </div>

                                </div>
                                <div class="portlet-body">
                                    <div class="table-toolbar">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="btn-group">
                                                    <a href="#retest" target="" data-toggle="modal" id="sample_editable_1_new" class="btn green">
                                                        新增 <i class="fa fa-plus"></i>
                                                    </a>
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                    <table class="table j_contentBox table-striped table-hover table-bordered" id="sample_editable_1">

                                    </table>
                                </div>
                            </div>
                            <!-- END EXAMPLE TABLE PORTLET-->
                        </div>
                        <div class="modal container fade" id="retest" tabindex="-1">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                                <h4 class="modal-title"></h4>
                            </div>
                            <div class="modal-body">
                                    <div class="form-body">
                                        <div class="row">
                                            <div class="form-group">
                                                <label class="control-label col-sm-2"><font color="red">*</font>页面名称：</label>

                                                <div class="col-md-4">
                                                    <input type="text" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" class="select2-input j_pagename select2-default" placeholder="" style="width: 276px;">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="form-group">
                                                <label class="control-label col-sm-2"><font color="red">*</font>输出路径：</label>

                                                <div class="col-md-4">
                                                    <input type="text" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" class="select2-input j_path select2-default" id="" placeholder="" style="width: 276px;">
                                                    <label><font color="red">例如：/test.html、/aa/bb/test.html</font></label>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                    <div class="form-actions">

                                    </div>

                                    <script id="editor" type="text/plain" style="width:auto;height:400px;"></script>
                            </div>
                            <div class="modal-footer">
                                <button type="button" data-dismiss="modal" class="btn btn-default">关闭</button>
                                <button type="button" class="btn j_save blue">保存</button>

                            </div>
                        </div>
                    </div>
                    <!-- END PAGE CONTENT -->


                </div>
            </div>
            <!-- END CONTENT -->

        </div>
        <!-- END CONTAINER -->
        <!-- BEGIN FOOTER -->


        <script id="userlist" type="text/html">
            <thead>
            <tr>
                <th>
                    编号
                </th>
                <th>
                    页面名称
                </th>
                <!--<th>-->
                    <!--页面标题-->
                <!--</th>-->
                <th>
                    输出路径
                </th>
                <!--<th>-->
                    <!--发布类型-->
                <!--</th>-->
                <!--<th>-->
                    <!--发布状态-->
                <!--</th>-->
                <th>
                    修改日期
                </th>
                <th>
                    修改人
                </th>
                <th>
                    操作
                </th>
            </tr>
            </thead>
            <tbody>
            {{each data as value i}}
            <tr data-id="{{value._id}}">
                <td>
                    {{value._id}}
                </td>
                <td>
                    {{value.pageName}}
                </td>
                <!--<td>-->
                    <!--{{value.pageTitle}}-->
                <!--</td>-->
                <td>
                    {{value.path}}
                </td>
                <!--<td>-->
                    <!--{{value.releaseType}}-->
                <!--</td>-->
                <!--<td>-->
                    <!--{{value.releaseStatus}}-->
                <!--</td>-->
                <td>
                    {{value.timeformat}}
                </td>
                <td>
                    {{value.updateBy}}
                </td>

                <td>
                    <a href="javascript:;" class="j_rease btn btn-danger" data-id="{{value._id}}">发布</a>
                    <a data-id="{{value._id}}" data-pagename="{{value.pageName}}" data-path="{{value.path}}" data-content="{{value.content}}" data-toggle="modal" class="edit btn default green" href="#retest">
                        修改 </a>
                    <a data-id="{{value._id}}" target="_blank" class="btn j_preview default green" href="/static/admin/template{{value.path}}">
                        预览 </a>
                    <a data-id="{{value._id}}" class="delete btn default red" href="javascript:;">
                        删除 </a>
                </td>

            </tr>
            {{/each}}
            </tbody>



        </script>

        <!-- END FOOTER -->
        <!-- BEGIN JAVASCRIPTS(Load javascripts at bottom, this will reduce page load time) -->
        <!-- BEGIN CORE PLUGINS -->
        <!--[if lt IE 9]>
        <script src="../../assets/global/plugins/respond.min.js"></script>
        <script src="../../assets/global/plugins/excanvas.min.js"></script>
        <![endif]-->
        <script src="../../assets/global/plugins/jquery.min.js" type="text/javascript"></script>
        <script src="../../assets/global/plugins/jquery-migrate.min.js" type="text/javascript"></script>
        <!-- IMPORTANT! Load jquery-ui.min.js before bootstrap.min.js to fix bootstrap tooltip conflict with jquery ui tooltip -->
        <script src="../../assets/global/plugins/jquery-ui/jquery-ui.min.js" type="text/javascript"></script>
        <script src="../../assets/global/plugins/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
        <script src="../../assets/global/plugins/bootstrap-hover-dropdown/bootstrap-hover-dropdown.min.js" type="text/javascript"></script>
        <script src="../../assets/global/plugins/jquery-slimscroll/jquery.slimscroll.min.js" type="text/javascript"></script>
        <script src="../../assets/global/plugins/jquery.blockui.min.js" type="text/javascript"></script>
        <script src="../../assets/global/plugins/jquery.cokie.min.js" type="text/javascript"></script>
        <script src="../../assets/global/plugins/uniform/jquery.uniform.min.js" type="text/javascript"></script>
        <script src="../../assets/global/plugins/bootstrap-switch/js/bootstrap-switch.min.js" type="text/javascript"></script>
        <!-- END CORE PLUGINS -->
        <!-- BEGIN PAGE LEVEL PLUGINS -->
        <script src="../../assets/global/plugins/bootstrap-modal/js/bootstrap-modalmanager.js" type="text/javascript"></script>
        <script src="../../assets/global/plugins/bootstrap-modal/js/bootstrap-modal.js" type="text/javascript"></script>
        <!-- END PAGE LEVEL PLUGINS -->
        <!-- BEGIN PAGE LEVEL PLUGINS -->
        <script type="text/javascript" src="../../assets/global/plugins/select2/select2.min.js"></script>
        <script type="text/javascript" src="../../assets/global/plugins/datatables/media/js/jquery.dataTables.min.js"></script>
        <script type="text/javascript" src="../../assets/global/plugins/datatables/plugins/bootstrap/dataTables.bootstrap.js"></script>
        <!-- END PAGE LEVEL PLUGINS -->
        <!-- BEGIN PAGE LEVEL PLUGINS -->
        <script src="../../assets/global/plugins/bootstrap-modal/js/bootstrap-modalmanager.js" type="text/javascript"></script>
        <script src="../../assets/global/plugins/bootstrap-modal/js/bootstrap-modal.js" type="text/javascript"></script>

        <script type="text/javascript" charset="utf-8" src="../../assets/global/plugins/ueditor/ueditor.config.js"></script>
        <script type="text/javascript" charset="utf-8" src="../../assets/global/plugins/ueditor/ueditor.all.min.js"></script>
        <script type="text/javascript" charset="utf-8" src="../../assets/global/plugins/ueditor/lang/zh-cn/zh-cn.js"></script>
        <!-- END PAGE LEVEL PLUGINS -->
        <!-- BEGIN PAGE LEVEL SCRIPTS -->
        <script src="../../assets/global/scripts/metronic.js" type="text/javascript"></script>
        <script src="../../assets/admin/layout/scripts/layout.js" type="text/javascript"></script>
        <script src="../../assets/admin/layout/scripts/quick-sidebar.js" type="text/javascript"></script>
        <script src="../../assets/admin/layout/scripts/demo.js" type="text/javascript"></script>
        <script src="../../assets/admin/layout/scripts/template.js"></script>
        <script src="../../assets/admin/pages/scripts/table-editable_temp.js"></script>
        <script src="../../assets/admin/pages/scripts/ui-extended-modals.js"></script>
        <script>

            jQuery(document).ready(function () {
//				Metronic.init(); // init metronic core components
//				Layout.init(); // init current layout
//				QuickSidebar.init(); // init quick sidebar
//				Demo.init(); // init demo features
                var $window = $(window);
                var isedit = 0;//0:当前弹出框为修改 1：当前弹出框新增
                var $messages = $('.messages'); // Messages area
                var socket = io();
                //新增数据
                var ue = UE.getEditor('editor') || null;
                template.helper('dateFormatCon', function (str, from) {

                    var arr = str.split(',');
                    var str2 = '';
                    for (var i = 0; i < arr.length; i++) {
                        str2 += '<div class="path">' + arr[i] + '</div>';
                    }
                    return str2;

                });
                initData();
                function initData() {//getuserbyname
                    $.ajax({
                        url: '/admin/template/gettepmlist',
                        type: 'POST',
                        cache: false,
                        complete: function (xhr, textStatus) {
                            if (textStatus == 'success' && xhr.status == '200') {
                                var response = eval("(" + xhr.responseText + ")");
                                window.console && console.log('getuserlist get data', response);
                                if (response.errno == 0) {//返回数据正常
                                    window.console && console.log('do updateall');
                                    var str = template('userlist', response);
                                    $('.j_contentBox').html(str);
                                    TableEditable.init();
                                } else {

                                }

                            } else {
                                window.console && console.log('error', xhr, textStatus);
                            }
                        }
                    });

                }


                $(document).on('click', '#sample_editable_1_new', function (e) {
                    isedit = 0;
                    $('div.retest').find('.modal-title').html('添加模板');
                    var $div = $('div#retest');
                    $div.find('.j_pagename').val('');
                    $div.find('.j_path').val('');
                    if(ue){
                        setTimeout(function(){
                            ue.setContent('');
                        },200);
                    }
                });

                //修改数据
                $(document).on('click','.edit',function(e){
                    isedit = 1;
                    var t = $(this);
                    var $div = $('div#retest');
                    $div.find('.j_pagename').val(t.attr('data-pagename'));
                    $div.find('.j_pagename').attr('data-id',t.attr('data-id'));
                    $div.find('.j_path').val(t.attr('data-path'));
                    if(ue){
                        setTimeout(function(){
                            ue.setContent(t.attr('data-content'));
                        },200);
                    }

                });

                function updateTableById(json){
                    window.console && console.log('json',json);
                    $.ajax({
                        url:'/admin/template/createtempfile',
                        type:'POST',
                        data:json,
                        complete:function(xhr, textStatus){
                            location.reload();
                        }
                    });
                }

                //保存修改或新增数据
                $(document).on('click','.j_save',function(e){
                    var t = $(this);
                    var $div = $('div#retest');
                    if(!$div.find('.j_pagename').val() || !$div.find('.j_path').val() ||  !ue.getContent() ){
                        alert('选项不能为空');
                        return;
                    }
                    if(!/\.(html|htm)$/.test($div.find('.j_path').val())){
                        alert('路径名称不正确');
                        return;
                    }
                    if(isedit == 1){//修改
                        var datajson = {
                            pageName:$div.find('.j_pagename').val(),
                            id:$div.find('.j_pagename').attr('data-id'),
                            path:$div.find('.j_path').val(),
                            content:ue.getContent()
                        };
                        $.ajax({
                            url:'/admin/template/updatedata',
                            type:'POST',
                            cache: false,
                            data:datajson,
                            complete:function(xhr, textStatus){
                                if(textStatus == 'success' && xhr.status == '200'){
                                    var response = eval("("+xhr.responseText+")");
                                    window.console && console.log('get data',response);
                                    if(response.errno == 0){//返回数据正常
                                        updateTableById(datajson);
                                        t.siblings('button').trigger('click');


                                    }else{
                                        alert('增加失败');
                                    }

                                }else{
                                    window.console && console.log('error',xhr, textStatus);
                                }
                            }
                        });
                    }else{//新增
                        var datajson = {
                            pageName:$div.find('.j_pagename').val(),
                            path:$div.find('.j_path').val(),
                            content:ue.getContent(),
                            updateBy: $.cookie('user')
                        };
                        $.ajax({
                            url: '/admin/template/addlist',
                            type: 'POST',
                            cache: false,
                            data:datajson,
                            complete: function (xhr, textStatus) {
                                if (textStatus == 'success' && xhr.status == '200') {
                                    var response = eval("(" + xhr.responseText + ")");
                                    window.console && console.log('getuserlist get data', response);
                                    if (response.errno == 0) {//返回数据正常
                                       updateTableById(datajson);
                                        t.siblings().trigger('click');

                                    } else {
                                        alert('添加失败');
                                    }

                                } else {
                                    window.console && console.log('error', xhr, textStatus);
                                }
                            }
                        });

                    }

                });

                $(document).on('click', '.j_test', function (e) {
                    $('div.retest').find('.modal-title').html('执行' + $(this).attr('data-name') + '命令');
                    var serverpath = $(this).attr('data-server').split(',');
                    var scriptPath = $(this).attr('data-script');
                    var userArr = $(this).attr('data-user').split(',');
                    var passArr = $(this).attr('data-pass').split(',');
                    var groupArr = $(this).attr('data-group').split(',');
                    window.console && console.log('123456');
                    e.stopPropagation();
                    $messages.empty();
                    setTimeout(function () {
                        socket.emit('execserver', {
                            scriptPath: scriptPath,
                            ipArr: serverpath,
                            userArr: userArr,
                            passArr: passArr,
                            groupArr: groupArr
                        });

                    }, 600);
                });
                socket.on('abc', function (data) {
                    //window.console && console.log('get socket message',data.message);
                    setCon(data.message)
                });
                function setCon(data) {
                    var $messageBodyDiv = $('<span class="messageBody">')
                            .html(data);
                    var $messageDiv = $('<li class="message"/>')
                            .append($messageBodyDiv);
                    var $el = $($messageDiv);
                    $messages.append($el);
                    $messages[0].scrollTop = $messages[0].scrollHeight;
                }

            });
        </script>
    </body>
    <!-- END BODY -->
</html>