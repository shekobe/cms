{% extends "../layout/layout.html" %}


{% block css %}
<!-- BEGIN PAGE LEVEL STYLES -->
<link href="/static/admin/theme/assets/global/plugins/bootstrap-modal/css/bootstrap-modal-bs3patch.css" rel="stylesheet" type="text/css"/>
<link href="/static/admin/theme/assets/global/plugins/bootstrap-modal/css/bootstrap-modal.css" rel="stylesheet" type="text/css"/>
<!--<link href="/static/admin/theme/assets/global/css/loaders.css.min.css" rel="stylesheet" type="text/css"/>-->
<!-- END PAGE LEVEL STYLES -->
<!-- BEGIN THEME STYLES -->
<link href="/static/admin/theme/assets/global/css/components.css" id="style_components" rel="stylesheet" type="text/css"/>
<link href="/static/admin/theme/assets/global/css/plugins.css" rel="stylesheet" type="text/css"/>
<link href="/static/admin/theme/assets/admin/layout/css/layout.css" rel="stylesheet" type="text/css"/>
<link id="style_color" href="/static/admin/theme/assets/admin/layout/css/themes/darkblue.css" rel="stylesheet" type="text/css"/>
<link href="/static/admin/theme/assets/admin/layout/css/custom.css" rel="stylesheet" type="text/css"/>

<link href="/static/admin/theme/assets/admin/pages/css/timeline.css" rel="stylesheet" type="text/css"/>
<!-- END THEME STYLES -->
<!-- END THEME STYLES -->
<link rel="shortcut icon" href="favicon.ico"/>

<!--<script src="http://chat.socket.io/socket.io/socket.io.js"></script>-->

<!--<script src="http://cdn.socket.io/socket.io-1.4.0.js"></script>-->

<style>
    .j_contentBox .timeline:before {
        background: #fff;
    }

    .page-container-bg-solid .timeline:before

    .timeline-badge-userpic {
        border-color: #fff;
    }


    .timeline-body {
        background-color: #fff;
    }

    .timeline-body-arrow {
        border-color: transparent #fff transparent transparent;
    }

    .portlet-body{
        background: #f1f3fa !important;
    }
    .timeline-yellow{
        background:linear-gradient(rgba(0, 0, 0, .2), rgba(255, 255, 255, .1) 50%, rgba(255, 255, 255, 0) 50.01%, rgba(255, 255, 255, 0)), linear-gradient(#0074ae, #073c66);
        color: #fff !important;
        border-radius: 25px !important;
    }
    .timeline-body-title{
        font-weight: normal!important;
    }
    .timeline-body a{
        color: #fff !important;
    }
    .timeline-body a.btn-g{
        color: #fff;
        border: 2px solid #fff;
        font-weight: bolder;
        font-size: 16px;
    }
    .timeline-yellow .timeline-body-arrow{
        border-color: linear-gradient(rgba(0, 0, 0, .2), rgba(255, 255, 255, .1) 50%, rgba(255, 255, 255, 0) 50.01%, rgba(255, 255, 255, 0)), linear-gradient(#0074ae, #073c66);
    }
    .timeline-yellow .panel{
        background: transparent;
    }
    .timeline-green{
        background: linear-gradient(rgba(0, 0, 0, .2), rgba(255, 255, 255, .1) 50%, rgba(255, 255, 255, 0) 50.01%, rgba(255, 255, 255, 0)), linear-gradient(#58aa00, #337100);
        color: #fff !important;
        border-radius: 25px !important;
    }
    .timeline-green .panel{
        background: transparent;
    }
    .timeline-green .timeline-body-arrow{
        border-color: linear-gradient(rgba(0, 0, 0, .2), rgba(255, 255, 255, .1) 50%, rgba(255, 255, 255, 0) 50.01%, rgba(255, 255, 255, 0)), linear-gradient(#58aa00, #337100);
    }
    .timeline-red{
        background: linear-gradient(rgba(0, 0, 0, .2), rgba(255, 255, 255, .1) 50%, rgba(255, 255, 255, 0) 50.01%, rgba(255, 255, 255, 0)), linear-gradient(#ff0071, #bb0047);
        color: #fff !important;
        border-radius: 25px !important;
    }
    .timeline-red .panel{
        background: transparent;
    }
    .timeline-red .timeline-body-arrow{
        background: linear-gradient(rgba(0, 0, 0, .2), rgba(255, 255, 255, .1) 50%, rgba(255, 255, 255, 0) 50.01%, rgba(255, 255, 255, 0)), linear-gradient(#ff0071, #bb0047);
    }
    /*.panel-group{*/
    /*margin-bottom: 0!important;*/
    /*}*/
    .timeline-red:focus, .timeline-red:hover {
        background: -webkit-gradient(linear, left top, left bottom, from(rgba(0, 0, 0, .1)), color-stop(.5, rgba(255, 255, 255, .2)), color-stop(.501, rgba(255, 255, 255, .1)), to(rgba(255, 255, 255, .1))), -webkit-gradient(linear, left top, left bottom, from(#ff0071), to(#bb0047));
        background: -webkit-linear-gradient(rgba(0, 0, 0, .1), rgba(255, 255, 255, .2) 50%, rgba(255, 255, 255, .1) 50.01%, rgba(255, 255, 255, .1)), -webkit-linear-gradient(#ff0071, #bb0047);
        background: -moz-linear-gradient(rgba(0, 0, 0, .1), rgba(255, 255, 255, .2) 50%, rgba(255, 255, 255, .1) 50.01%, rgba(255, 255, 255, .1)), -moz-linear-gradient(#ff0071, #bb0047);
        background: -ms-linear-gradient(rgba(0, 0, 0, .1), rgba(255, 255, 255, .2) 50%, rgba(255, 255, 255, .1) 50.01%, rgba(255, 255, 255, .1)), -ms-linear-gradient(#ff0071, #bb0047);
        background: -o-linear-gradient(rgba(0, 0, 0, .1), rgba(255, 255, 255, .2) 50%, rgba(255, 255, 255, .1) 50.01%, rgba(255, 255, 255, .1)), -o-linear-gradient(#ff0071, #bb0047);
        background: linear-gradient(rgba(0, 0, 0, .1), rgba(255, 255, 255, .2) 50%, rgba(255, 255, 255, .1) 50.01%, rgba(255, 255, 255, .1)), linear-gradient(#ff0071, #bb0047);

    }

    .timeline-yellow:focus, .timeline-yellow:hover {
        background: -webkit-gradient(linear, left top, left bottom, from(rgba(0, 0, 0, .1)), color-stop(.5, rgba(255, 255, 255, .2)), color-stop(.501, rgba(255, 255, 255, .1)), to(rgba(255, 255, 255, .1))), -webkit-gradient(linear, left top, left bottom, from(#0074ae), to(#073c66));
        background: -webkit-linear-gradient(rgba(0, 0, 0, .1), rgba(255, 255, 255, .2) 50%, rgba(255, 255, 255, .1) 50.01%, rgba(255, 255, 255, .1)), -webkit-linear-gradient(#0074ae, #073c66);
        background: -moz-linear-gradient(rgba(0, 0, 0, .1), rgba(255, 255, 255, .2) 50%, rgba(255, 255, 255, .1) 50.01%, rgba(255, 255, 255, .1)), -moz-linear-gradient(#0074ae, #073c66);
        background: -ms-linear-gradient(rgba(0, 0, 0, .1), rgba(255, 255, 255, .2) 50%, rgba(255, 255, 255, .1) 50.01%, rgba(255, 255, 255, .1)), -ms-linear-gradient(#0074ae, #073c66);
        background: -o-linear-gradient(rgba(0, 0, 0, .1), rgba(255, 255, 255, .2) 50%, rgba(255, 255, 255, .1) 50.01%, rgba(255, 255, 255, .1)), -o-linear-gradient(#0074ae, #073c66);
        background: linear-gradient(rgba(0, 0, 0, .1), rgba(255, 255, 255, .2) 50%, rgba(255, 255, 255, .1) 50.01%, rgba(255, 255, 255, .1)), linear-gradient(#0074ae, #073c66);

    }

    .timeline-green:focus, .timeline-green:hover {
        background: -webkit-gradient(linear, left top, left bottom, from(rgba(0, 0, 0, .1)), color-stop(.5, rgba(255, 255, 255, .2)), color-stop(.501, rgba(255, 255, 255, .1)), to(rgba(255, 255, 255, .1))), -webkit-gradient(linear, left top, left bottom, from(#58aa00), to(#337100));
        background: -webkit-linear-gradient(rgba(0, 0, 0, .1), rgba(255, 255, 255, .2) 50%, rgba(255, 255, 255, .1) 50.01%, rgba(255, 255, 255, .1)), -webkit-linear-gradient(#58aa00, #337100);
        background: -moz-linear-gradient(rgba(0, 0, 0, .1), rgba(255, 255, 255, .2) 50%, rgba(255, 255, 255, .1) 50.01%, rgba(255, 255, 255, .1)), -moz-linear-gradient(#58aa00, #337100);
        background: -ms-linear-gradient(rgba(0, 0, 0, .1), rgba(255, 255, 255, .2) 50%, rgba(255, 255, 255, .1) 50.01%, rgba(255, 255, 255, .1)), -ms-linear-gradient(#58aa00, #337100);
        background: -o-linear-gradient(rgba(0, 0, 0, .1), rgba(255, 255, 255, .2) 50%, rgba(255, 255, 255, .1) 50.01%, rgba(255, 255, 255, .1)), -o-linear-gradient(#58aa00, #337100);
        background: linear-gradient(rgba(0, 0, 0, .1), rgba(255, 255, 255, .2) 50%, rgba(255, 255, 255, .1) 50.01%, rgba(255, 255, 255, .1)), linear-gradient(#58aa00, #337100);

    }

</style>
<style>
    .timeline-time span.date {
        font-size: 12px;
        color: #aaa;
        display: block;
        font-weight: 300;
    }
    .timeline-time span {
        display: block;
        text-align: right;
    }
    .timeline-time span.time {
        color: #35aa47;
    }
    .timeline-time span.time {
        font-weight: 300;
        font-size: 38px;
        line-height: 38px;
    }
    .timeline-time span {
        display: block;
        text-align: right;
    }
    .timeline-body {
        margin-left: 240px !important;
    }
    .j_contentBox .timeline:before {

        margin-left: 172px !important;
    }
    .timeline-time{
        float: left;
        position: relative;
        padding-right: 30px;
        padding-top: 10px;
        height: 80px;
        width: 134px;
    }
    .timeline-body-content {
        margin-top: 15px !important;
    }

    .panel-group {
        margin-bottom: 0px !important;
    }

    .timeline-body{
        padding:10px 10px 10px 20px !important;

    }
</style>

{% endblock %}


{% block container %}
<div class="row ">
    <div>
        <div class="col-md-12">
            <a data-toggle="modal" class="j_shouye green btn" href="#responsiveCDN" target="_blank">点击推送首页cdn</a>
        </div>
        <div class="col-md-12" style="margin-top: 15px;">
            <div class="form-group">
                <div class="radio-list">
                    <label class="radio-inline">
                        <div class="radio" id="uniform-optionsRadios4">
                            <input class="j_pushwj" type="radio" name="optionsRadios" id="optionsRadios4" value="url" checked="">
                        </div> 推文件 </label>
                    <label class="radio-inline">
                        <div class="radio" id="uniform-optionsRadios5">
                            <input class="j_pushml" type="radio" name="optionsRadios" id="optionsRadios5" value="dir">
                        </div> 推目录 </label>
                </div>
            </div>
            <div class="col-md-12">
                <div class="input-group">
                    <span class="input-group-btn">
                        <button class="btn j_clear red" type="button">清空文本</button>
                    </span>
                    <input placeholder="多条推送用;隔开，如：http://www.360shouji.com/static/css/index.css;http://www.360shouji.com/product/q5/fast.html" type="text" class="form-control j_sdpush_cont">
                    <span class="input-group-btn">

                        <a data-toggle="modal" class="j_sdpush blue btn" href="#responsiveCDN" target="_blank">手动推送cdn</a>
                    </span>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-12">
        <!-- BEGIN PORTLET-->
        <div class="portlet box">
            <div class="portlet-body">
                <div class="row">
                    <div class="col-md-12">
                        <div class="tab-content j_contentBox">
                        </div>
                    </div>
                    <!-- responsive -->
                    <div id="responsive" class="modal fade" tabindex="-1" data-width="760">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                            <h4 class="modal-title">发布文件</h4>
                        </div>
                        <div class="modal-body" style="background-color: rgb(29, 29, 29);color: rgb(255, 255, 255);">
                            <div class="row">
                                <div class="col-md-12">
                                    <ul style="height: 500px;margin: 0;overflow-y: scroll;padding: 10px 20px 10px 20px;" class="messages">
                                        <li class="message">
                                            <span class="messageBody">sdfsdfds</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" data-dismiss="modal" class="btn btn-default">Close</button>
                            <!--<button type="button" class="btn blue">Save changes</button>-->
                        </div>
                    </div>
                    <div id="responsiveCDN" class="modal fade" tabindex="-1" data-width="760">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                            <h4 style="font-size: 20px;" class="modal-title">更新cdn</h4>
                        </div>
                        <div class="modal-body">
                            <div style="height: 100px;" class="row">
                                <div style="font-size: 14px;" class="col-md-2">
                                    更新文件：
                                </div>
                                <div class="col-md-10 j_cdnfile">
                                </div>
                            </div>
                            <div style="height: 100px;" class="row">
                                <div style="font-size: 14px;" class="col-md-2">
                                    更新目录：
                                </div>
                                <div class="col-md-10 j_cdndir">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button style="display: none;" type="button" class="btn j_repairtoken btn-success">修复access_token</button>
                            <button type="button" data-dismiss="modal" class="btn btn-default">Close</button>
                            <!--<button type="button" class="btn blue">Save changes</button>-->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- END PORTLET-->
    </div>
</div>


{% endblock %}

{% block script %}
<script src="/static/admin/theme/assets/admin/layout/scripts/socket.io.js"></script>
<script src="/static/admin/theme/assets/global/plugins/bootstrap-modal/js/bootstrap-modalmanager.js" type="text/javascript"></script>
<script src="/static/admin/theme/assets/global/plugins/bootstrap-modal/js/bootstrap-modal.js" type="text/javascript"></script>
<script src="/static/admin/theme/assets/global/scripts/md5.js"></script>
<script src="/static/admin/theme/assets/admin/pages/scripts/ui-extended-modals.js"></script>
<script src="/static/admin/theme/assets/admin/layout/scripts/template.js"></script>

<script id="userlist" type="text/html">
    {{if data.length == 0}}
    暂无更新数据。
    {{/if}}

    <div class="timeline">
        {{each data as value i}}

        <!-- TIMELINE ITEM -->
        <div class="timeline-item">
            <div class="timeline-time">
								<span class="date">
									 {{value.time | dateFormat}}
							</span>
								<span class="time">
								{{value.time | dateFormat2}} </span>
            </div>
            <div class="timeline-badge">
                <img class="timeline-badge-userpic" src="/static/admin/theme/assets/admin/pages/media/users/{{value.user}}.jpg">


            </div>
            {{if value.status == 'close'}}
            <div class="timeline-body timeline-green">
                {{else if value.status == 'close27'}}
                <div class="timeline-body timeline-yellow">
                    {{else if value.status == 'open'}}
                    <div class="timeline-body timeline-red">
                        {{/if}}

                        <div class="timeline-body-arrow">
                        </div>
                        <!--<div class="timeline-body-head">-->
                        <!--<div class="timeline-body-head-caption">-->
                        <!--<span class="timeline-body-title ">{{value.user}}</span>-->
                        <!--<span class="timeline-body-time">{{value.time | dateFormatTime}}</span>-->
                        <!--</div>-->

                        <!--</div>-->
                        <div class="timeline-body-content">

                            <div id="tab_{{i}}" class="tab-pane active">
                                <div id="accordion{{i}}" class="panel-group">


                                    <div class="panel ">
                                        <div class="panel collapsed" data-toggle="collapse" data-parent="#accordion{{i}}" href="#accordion1_{{i}}" aria-expanded="false">

                                            <h4 class="panel-title" style="font-weight: bolder;">
                                                {{value.msg}}
                                            </h4>

                                            <div style="float: right">


                                                <a class="j_submit btn btn-g" data-status="{{value.status}}" data-id="{{value._id}}" data-toggle="modal" href="#responsive" data-con="{{value.con}}">发布到测试</a>

                                                <a data-status="{{value.status}}" data-toggle="modal" href="#responsive" class="j_submit2 btn btn-g" id="{{value._id}}" data-id="{{value._id}}" data-con="{{value.con}}">发布到生产</a>

                                                <a data-toggle="modal" class="j_pushcdn btn btn-g" href="#responsiveCDN" id="{{value._id}}" target="_blank" data-id="{{value._id}}" data-con="{{value.con}}">推送CDN</a>
                                                <a style="visibility: hidden" class="j_del btn default red" data-id="{{value._id}}">删除</a>
                                            </div>
                                            <div style="padding-top: 10px;">
								<span>

									{{if value.operator}}
									 <img class="timeline-badge-userpic" style="width: 50px;height: 50px;" src="/static/admin/theme/assets/admin/pages/media/users/{{value.operator}}.jpg">
									{{/if}}


								   <!--{{if value.status == 'open'}}-->
									<!--未处理-->
									<!--{{else if value.status == 'close'}}-->
									<!--{{value.operator}}-->
									<!--{{else if value.status == 'close27'}}-->
									<!--{{value.operator}}-->
									<!--{{/if}}-->



								</span>
                                            </div>
                                        </div>
                                        <div id="accordion1_{{i}}" class="panel-collapse collapse" aria-expanded="false" style="height: 0px;">
                                            <div class="panel-body">
                                                {{value.con | dateFormatCon}}
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- END TIMELINE ITEM -->

                {{/each}}
            </div>

</script>
<script>
    jQuery(document).ready(function () {
//				// initiate layout and plugins
//				Metronic.init(); // init metronic core components
//				Layout.init(); // init current layout
//				QuickSidebar.init(); // init quick sidebar
//				Demo.init(); // init demo features  // set current page
//				ComponentsKnobDials.init();

        UIExtendedModals.init();
        template.helper('dateFormat', function (dateTime,from) {

            var oldStr = new Date(dateTime);
            var arr = [oldStr.getFullYear(),oldStr.getMonth()+1,oldStr.getDate()];
            arr[1] = parseInt(arr[1]) < 10 ? '0'+arr[1] : arr[1];
            var weekArray = new Array("星期日", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六");
            var week_i = new Date(arr[0]+'/'+arr[1]+'/'+arr[2]).getDay();
            var week = weekArray[week_i];
            return arr[0]+'/'+arr[1]+'/'+arr[2]+' '+week;

        });
        template.helper('dateFormat2', function (dateTime,from) {


            var oldStr = new Date(dateTime);

            return oldStr.getHours()+':'+oldStr.getMinutes();


        });
        template.helper('dateFormatCon', function (str, from) {

            var str = str.substring(1, str.length - 1);
            var arr = str.split(',');
            var str2 = '';
            for (var i = 0; i < arr.length; i++) {
                str2 += '<div class="path">' + arr[i] + '</div>';
            }
            return str2;

        });
        template.helper('dateFormatTime', function (str, from) {

            var oldStr = new Date(str);

            return 'at '+(oldStr.getMonth()+1)+'/'+oldStr.getDate()+' '+oldStr.getHours()+':'+oldStr.getMinutes();

        });
        // Initialize varibles
        var $window = $(window);
        var $messages = $('.messages'); // Messages area
        var socket = io();

        function checklogin(){
            if(sesisonObj.username){
                return true;
            }else{
                return false;
            }


        }
        if(!checklogin()){
           // window.location.reload();
            //location.href = '/admin/login/logout';
            return;
        }
        window.console && console.log('5555555555555');
        initData();
        function initData() {//getuserbyname
            $.ajax({
                url: '/admin/user/getuserbyname3',
                type: 'POST',
                cache: false,
                complete: function (xhr, textStatus) {

                    if (textStatus == 'success' && xhr.status == '200') {
                        var response = eval("(" + xhr.responseText + ")");
                        window.console && console.log('get $.cookie(qiku)data', response,sesisonObj.username);
                        if (response.errno == 0) {//返回数据正常
                            socket.emit('updateall', {
                                user: sesisonObj.username
                            });
                            var str = template('userlist', response);
                            $('.j_contentBox').html(str);
                            $('.j_textarea').val('');
                        } else {

                        }

                    } else {
                        window.console && console.log('error', xhr, textStatus);
                    }
                }
            });

        }

        //下载数据j_download    /admin/user/download
        var cflag = true;
        $(document).on('click', '.j_download', function (e) {
            if(!checklogin()){
                window.location.reload();
                return;
            }
            if (!cflag) {
                return;
            }
            cflag = false;
            e.stopPropagation();
            var t = $(this);
            var str = $.trim(t.attr('data-con'));
            //t.html('<img height="15" width="56" src="/static/theme/assets/admin/layout/img/loadingbg.gif">');
            t.html('<div class="loader" style="height: 20px;overflow: hidden;width: 70px;"><div class="loader-inner pacman"><div></div><div></div><div></div><div></div><div></div></div></div>');
            window.console && console.log('str', str);
            //return;

            setTimeout(function () {
                socket.emit('downloadlist', {
                    id: t.attr('data-id'),
                    dom: t,
                    str: t.attr('data-con')
                });

            }, 300);

        });

        $(document).on('click', '.j_clear', function (e) {
            $('.j_sdpush_cont').val('');
        });
        //手动推
        $(document).on('click', '.j_sdpush', function (e) {
            if(!checklogin()){
                window.location.reload();
                return;
            }
            $('#ifr_content2').hide();
            var str = $('.j_sdpush_cont').val();
            var isdirorurl = $('input[name="optionsRadios"]:checked').val();
            //if(isdirorurl =='url'){//推文件


            var  data2 = {
                str:str,
                type:isdirorurl == 'url' ? 1:0
            };
            updateAllCDN(data2);

        })

        function updateCDN(data,callback){
            $.ajax({
                url: '/admin/release/updatefiledir',
                type: 'POST',
                data: data,
                async:false,
                cache: false,
                complete: function (xhr, textStatus) {
                    if (textStatus == 'success' && xhr.status == '200') {
                        var response = eval("(" + xhr.responseText + ")");
                        window.console && console.log('res', response);
                        callback(response.data);

                    } else {
                        var response = eval("(" + xhr.responseText + ")");
                        callback(response);
                        window.console && console.log('error', xhr, textStatus);
                    }
                }
            });
        }
        $(document).on('click', '.j_repairtoken', function (e) {
            $.ajax({
                url: '/admin/release/deletecdntoken',
                type: 'POST',
                cache: false,
                complete: function (xhr, textStatus) {
                    if (textStatus == 'success' && xhr.status == '200') {
                        var response = eval("(" + xhr.responseText + ")");
                        window.console && console.log('res', response);
                        toastr.success('修复成功，请重新推送CDN，无须刷新页面');

                    } else {
                        var response = eval("(" + xhr.responseText + ")");
                        toastr.error('修复失败，请重新刷新页面再试');
                        window.console && console.log('error', xhr, textStatus);
                    }
                }
            });
        });

        function updateAllCDN(data,data2){
            $('.j_cdnfile,.j_cdndir').html('').closest('.row').hide();
            $('.j_repairtoken').hide();
            if(data.str){
                updateCDN(data,function(res){
                    var obj = data.type == 1 ? $('.j_cdnfile'):$('.j_cdndir');
                    obj.html(JSON.stringify(res));
                    obj.closest('.row').show();
                    window.console && console.log('res',res)
                    if(res.status){
                        obj.append('&nbsp;<span><img src="/static/admin/theme/assets/admin/layout/img/suc.png" alt=""></span>');
                    }else{
                        obj.append('<span><img src="/static/admin/theme/assets/admin/layout/img/fi.png" alt=""></span>');
                        //如果是token失效
                        if(res.info == 'access_token无效'){
                            $('.j_repairtoken').show();
                        }
                    }

                });

            }
            if(data2 && data2.str){
                updateCDN(data2,function(res){
                    var obj = data2.type == 1 ? $('.j_cdnfile'):$('.j_cdndir');
                    obj.html(JSON.stringify(res));
                    obj.closest('.row').show();
                    window.console && console.log('res',res)
                    if(res.status){
                        obj.append('&nbsp;<span><img src="/static/admin/theme/assets/admin/layout/img/suc.png" alt=""></span>');
                    }else{
                        obj.append('<span><img src="/static/admin/theme/assets/admin/layout/img/fi.png" alt=""></span>');
                        //如果是token失效
                        if(res.info == 'access_token无效'){
                            $('.j_repairtoken').show();
                        }
                    }
                });

            }
        }

        //推首页cdn
        $(document).on('click', '.j_shouye', function (e) {
            if(!checklogin()){
                window.location.reload();
                return;
            }
            var  data = {
                str:'http://www.360shouji.com/index.html;http://www.360shouji.com/static/img/product/ultimate/img4-1.png',
                type:1
            };
            var  data2 = {
                str:"http://www.360shouji.com/service/outlets/;http://www.360shouji.com/home/",
                type:0
            };
            updateAllCDN(data2,data);
        })


        //推送CDN
        $(document).on('click', '.j_pushcdn', function (e) {
            if(!checklogin()){
                window.location.reload();
                return;
            }
            e.stopPropagation();
            var url = '';
            var url2 = '';
            var t = $(this);
            var id = t.attr('data-id');
            var str = $.trim(t.attr('data-con'));
            var arr = str.substring(1, str.toString().length - 1);
            window.console && console.log('arr', arr);
            var reg = /[^,]+(?=.html|.css|.jpg|.gif|.png|.jpeg|.js|.mp4|.mp3|.ogv|.webm|.eot|.ttf|.woff)[^,]+/g;//获取所有html、 资源的文件
            var result = arr.match(reg) || [];
            var result2 = arr.match(reg) || [];
            var str2 = '';
            var str3 = '';
            if (result.length) {
                for (var i = 0; i < result.length; i++) {

                    window.console && console.log('result[i]',result[i]);
                    if ( /\.html$/.test(result[i])) {//

                        result[i] = 'http://www.360shouji.com' + result[i];
                        result2[i] = 'http://www.360shouji.com' + result2[i];
                        str2 += result[i] + ';';
                        str3 += result2[i] + ';';
                    }
                    if (/\.js$/.test(result[i])) {//
                        result[i] = 'http://www.360shouji.com' + result[i];
                        str2 += result[i] + ';';
                    }
                    if (/\.css$/.test(result[i])) {//
                        result[i] = 'http://www.360shouji.com' + result[i];
                        str2 += result[i] + ';';
                    }
                    if (/\.(jpg|gif|png|jpeg|mp4|mp3|ogv|webm|eot|ttf|woff)$/.test(result[i])) {//
                        result[i] = 'http://www.360shouji.com' + result[i];
                        str2 += result[i] + ';';
                    }



                }
                if (str2) {
                    //正则过滤 目录 www,view/home
                    str2 = str2.replace(/\/www\//g,'/').replace(/\/view\/home\//g,'/');
                    //正则过滤 目录 www,view/home
                    str3 = str3.replace(/\/www\//g,'/').replace(/\/view\/home\//g,'/').replace(/\.html/g,'/');
                    str2 = str2.substring(0, str2.length - 1);
                    str3 = str3.substring(0, str3.length - 1);
                }

            } else {
                alert('当前没有要更新cdn的文件');
                return;
            }
            if (!str2) {
                alert('当前没有要更新cdn的文件');
                return;
            }

            window.console && console.log('str2',str2);
            window.console && console.log('str3',str3);

            var  data = {
                str:str2,
                type:1
            };
            var  data2 = {
                str:str3,
                type:0
            };
            updateAllCDN(data2,data);


        });
        var showflag = -1;
        $(document).on('mouseenter','.timeline-body-content',function(){
            var t = $(this);
            clearTimeout(showflag);
            showflag = setTimeout(function(){
                t.find('.j_del').css('visibility','visible');
            },300);
        });
        $(document).on('mouseleave','.timeline-body-content',function(){
            var t = $(this);
            clearTimeout(showflag);
            t.find('.j_del').css('visibility','hidden');
        });
        //删除数据
        $(document).on('click', '.j_del', function (e) {
            if(!checklogin()){
                window.location.reload();
                return;
            }
            e.stopPropagation();
            var id = $(this).attr('data-id');
            if(confirm("确定要删除数据吗？"))
            {
                $.ajax({
                    url: '/admin/user/deldata',
                    type: 'POST',
                    data: {
                        id: id
                    },
                    cache: false,
                    complete: function (xhr, textStatus) {
                        if (textStatus == 'success' && xhr.status == '200') {
                            var response = eval("(" + xhr.responseText + ")");
                            window.console && console.log('res', response);
                            if (response.errno == 0) {//返回数据正常
                                initData();

                            } else {

                            }

                        } else {
                            window.console && console.log('error', xhr, textStatus);
                        }
                    }
                });
            }



        });
        //发布到27测试环境
        $(document).on('click', '.j_submit', function (e) {
            if(!checklogin()){
                window.location.reload();
                return;
            }
            e.stopPropagation();
            $messages.empty();
            var t = $(this);
            var str = $.trim(t.attr('data-con'));
            //window.console && console.log('str',str);
            var arr = str.substring(1, str.toString().length - 1);
            window.console && console.log('arr', arr);
            var reg = /[^,]+(?=.html|.jsp|.mp4|.mp3|.ogv|.webm|.eot|.ttf|.woff|.swf)[^,]+/g;//获取所有.html的文件
            var reg2 = /[^,]+(?=.css|.jpg|.gif|.png|.jpeg|.js|.mp4|.mp3|.ogv|.webm|.eot|.ttf|.woff)[^,]+/g;//获取所有非.html的文件
            var result = arr.match(reg) || [];
            var result2 = arr.match(reg2) || [];
            window.console && console.log('result', result);
            window.console && console.log('result2', result2);

            var str2 = '';
            var str3 = '';
            if (result.length) {
                for (var i = 0; i < result.length; i++) {
                    if (/\.(html|jsp|mp4|mp3|ogv|webm|eot|ttf|woff|swf)$/.test(result[i])) {//
                        str2 += result[i] + ',';
                    }
                }
                str2 = str2.substring(0, str2.length - 1);
                if (str2) {
                    str2 = "{" + str2 + "}";
                }
            }
            if (result2.length) {
                for (var i = 0; i < result2.length; i++) {
                    if ( /\.(js|css|jpg|gif|png|jpeg|mp4|mp3|ogv|webm|eot|ttf|woff)$/.test(result2[i])) {//
                        str3 += result2[i] + ',';
                    }

                }
                str3 = str3.substring(0, str3.length - 1);
                if (str3) {
                    str3 = "{" + str3 + "}";
                }

            }

            window.console && console.log('obj', {
                id: t.attr('data-id'),
                res: str3,
                status: t.attr('data-status'),
                username:sesisonObj.username,
                html: str2
            });
            window.console && console.log('str3', str3);
            setTimeout(function () {
                window.console && console.log('1111',socket);
                socket.emit('addlist', {
                    id: t.attr('data-id'),
                    res: str3,
                    status: t.attr('data-status'),
                    username:sesisonObj.username,
                    html: str2
                });
                window.console && console.log('2222');

            }, 300);

        });
        //发布到99生产环境
        $(document).on('click', '.j_submit2', function (e) {
            if(!checklogin()){
                window.location.reload();
                return;
            }
            e.stopPropagation();
            $messages.empty();
            var t = $(this);
            var str = $.trim(t.attr('data-con'));
            //window.console && console.log('str',str);
            var arr = str.substring(1, str.toString().length - 1);
            window.console && console.log('arr', arr);
            var reg = /[^,]+(?=.html|.jsp|.mp4|.mp3|.ogv|.webm|.eot|.ttf|.woff|.swf)[^,]+/g;//获取所有.html的文件
            var reg2 = /[^,]+(?=.css|.jpg|.gif|.png|.jpeg|.js|.mp4|.mp3|.ogv|.webm|.eot|.ttf|.woff)[^,]+/g;//获取所有非.html的文件
            var result = arr.match(reg) || [];
            var result2 = arr.match(reg2) || [];
            window.console && console.log('result', result);
            window.console && console.log('result2', result2);

            var str2 = '';
            var str3 = '';
            if (result.length) {
                for (var i = 0; i < result.length; i++) {
                    if (/\.(html|jsp|mp4|mp3|ogv|webm|eot|ttf|woff|swf)$/.test(result[i])) {//
                        str2 += result[i] + ',';
                    }
                }
                str2 = str2.substring(0, str2.length - 1);
                if (str2) {
                    str2 = "{" + str2 + "}";
                }
            }
            if (result2.length) {
                for (var i = 0; i < result2.length; i++) {
                    if ( /\.(js|css|jpg|gif|png|jpeg|mp4|mp3|ogv|webm|eot|ttf|woff)$/.test(result2[i])) {//
                        str3 += result2[i] + ',';
                    }

                }
                str3 = str3.substring(0, str3.length - 1);
                if (str3) {
                    str3 = "{" + str3 + "}";
                }

            }


            window.console && console.log('str2', str2);
            window.console && console.log('str3', str3);
            setTimeout(function () {
                socket.emit('addlist2', {
                    id: t.attr('data-id'),
                    res: str3,
                    status: t.attr('data-status'),
                    username:sesisonObj.username,
                    html: str2
                });

            }, 300);

        });
        socket.on('downloadpath', function (data) {

            window.console && console.log('downloadpath', data.path);
            var obj = $('#' + data.id);
            obj.html('下载压缩包');
            //window.console && console.log('obj',obj,obj.length,obj.siblings('a.j_dd').length);
            //obj.siblings('a.j_dd').addClass('btn blue').attr('href','/admin/user/download?name='+data.path).html('点击下载');
            location.href = '/admin/user/download?name=' + data.path;
            cflag = true;

        });
        socket.on('abc', function (data) {
            //window.console && console.log('get socket message',data.message);
            setCon(data.message)
        });

//				socket.on('updataDataList', function (data) {
//					window.console && console.log('commentlist get socket',data);
//				});

        //发布成功后的回调
        socket.on('result', function (data) {
            window.console && console.log('get result message', data);
            $.ajax({
                url: '/admin/user/updatedata',
                type: 'POST',
                cache: false,
                data: {
                    id: data.id,
                    status: data.status,
                    oldstatus: data.oldstatus,
                    username: sesisonObj.username
                },
                complete: function (xhr, textStatus) {
                    if (textStatus == 'success' && xhr.status == '200') {
                        var response = eval("(" + xhr.responseText + ")");
                        window.console && console.log('get data', response);
                        if (response.errno == 0) {//返回数据正常
                            initData();
                        } else {

                        }

                    } else {
                        window.console && console.log('error', xhr, textStatus);
                    }
                }
            });
        });

        function setCon(data) {
            var $messageBodyDiv = $('<span class="messageBody">')
                    .html(data);
            var $messageDiv = $('<li class="message"/>')
                    .append($messageBodyDiv);
            var $el = $($messageDiv);
            $messages.append($el);
            $messages[0].scrollTop = $messages[0].scrollHeight;
        }

    });
</script>
{% endblock %}

