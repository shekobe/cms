{% extends "../layout/layout.html" %}{% block css %}<link rel="stylesheet" type="text/css" href="/static/css/help/help.css"><link rel="stylesheet" href="http://api.map.baidu.com/library/SearchInfoWindow/1.5/src/SearchInfoWindow_min.css" />{% endblock %}{% block container %}<div class="container">    {% include "./help_silder.html" %}       <div class="helparticle">           <h2>服务网点查询</h2>         <div class="helpmain serviceshop">            <!-- 省份 -->            <h3>省份地区</h3>            <div id="service_provice">                            </div>            <div id="service_city">                            </div>            <!-- 服务网点列表 -->            <div id="service_list">                            </div>            <!-- 分页 -->            <div id="service_page">                            </div>            <!-- layout  -->            <div id="service_detail">                <a href="javascript:;" title="关闭" class="closeit">X</a>                <div class="one_shop_info j_contentBox clearfix" style="height: 260px;background:#fff;">                </div>                <!-- 地图 -->                <div class="maps">                    <div class="map_location">                        <a href="javascript:;" onclick="mapZoom();" class="large"><i></i></a>                        <a href="javascript:;" onclick="mapShrink();" class="small"><i></i></a>                        <a href="javascript:;" onclick="mapLocate();" class="my_location"><i></i></a>                    </div>                    <div id="allmap" style="width:100%;height:100%;">地图正在加载中...</div>                </div>            </div>         </div>      </div>    <script type="text/template" id="serviceList">        {{each data as value}}        <div class="service-shop" data-id="{{value.id}}" data-city="{{value.cityId}}" data-index="{{ $index }}" style="{{if $index>4}}display:none;{{/if}}">            <div class="service_img"><img src="{{if value.img!=''}}{{value.img}}{{else}}http://res.qiku.com/images/help_center/service-default.png{{/if}}"></div>            <div class="service_info" data-lon="{{value.longitude}}" data-lat="{{value.latitude}}">                <h3 class="service_name"><b>{{value.netName}}</b>{{if value.buildLevel!=''}}<i>{{value.buildLevel}}</i>{{/if}}</h3>                <p class="service_address">地址：<b>{{value.businessAddress}}</b></p>                <p class="service_tel">联系电话：<b>{{value.servicePhone}}</b></p>                <p class="service_wtime">营业时间：<b>{{value.businessHours}}</b></p>            </div>        </div>        {{/each}}    </script>    <script type="text/template" id="temp_comment">        <div class="shop_imgs">           <img src="{{img}}" alt="" />        </div>        <div class="shop_detail">            <h2>                {{netName}}            </h2>            <div class="sd_rows">                <label>电　　话：</label>                <span>  {{servicePhone}}</span>            </div>            <div class="sd_rows">                <label>地　　址：</label>                <span>  {{businessAddress}}</span>            </div>            <div class="sd_rows">                <label>营业时间：</label>                <span>   {{businessHours}}</span>            </div>        </div>    </script></div>{% endblock %}{% block script %}<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=EwoloGLFejE5PKSz12CvW7U9y9mW2XBo"></script> <script type="text/javascript" src="http://api.map.baidu.com/library/SearchInfoWindow/1.5/src/SearchInfoWindow_min.js"></script><script type="text/javascript">    ;jQuery(function(){        //服务网点        if($('#service_provice').length >0){            getArea(0);            // golbmap();            //省份切换            $('#service_provice').delegate('a', 'click', function(event) {                var id = parseInt($(this).attr('data-id'));                $(this).addClass('on').siblings('a').removeClass('on');                getCitys(id);            });//城市            $('#service_city').delegate('a', 'click', function(event) {                var id = parseInt($(this).attr('data-id')),                pid = parseInt($(this).attr('data-proid'));                $(this).addClass('on').siblings('a').removeClass('on');                getserviceList(pid,id);            });            //分页切换            $('#service_page').delegate('a', 'click', function(event) {                var page = parseInt($(this).attr('data-page'));                $(this).addClass('on').siblings('a').removeClass('on');                $('.service-shop').each(function(index){                    if(index>(page-1)*5 && index <= page*5 ){                        $(this).show();                    }else{                        $(this).hide();                    }                });                $(window).scrollTop(100);            });            //弹出层            $('#service_list').delegate('h3', 'click', function(event) {                var pa =$(this).parent('.service_info');                var data={                    id:pa.parent('.service-shop').attr('data-id'),                    img:pa.siblings('.service_img').find('img').attr('src'),                    netName:pa.find('.service_name b').text(),                    businessAddress:pa.find('.service_address b').text(),                    servicePhone:pa.find('.service_tel b').text(),                    businessHours:pa.find('.service_wtime b').text(),                    latitude:pa.attr('data-lat'),                    longitude:pa.attr('data-lon')};                //console.log(data);                    //初始化                var html = template('temp_comment',data);                $('.j_contentBox').html(html);                $('#service_detail').show();                initmap(data);                $(window).scrollTop(100);            });            $('#service_detail').delegate('.closeit', 'click', function(event) {                $('#service_detail').hide();            });        }        //地区        function getArea(id){            if(id == undefined) id = 0;            $.ajax({                url: getPath('www')+'/member/getServiceArea.htm',                type: 'GET',                dataType: 'json',                data: {provinceid:id},            }).done(function(data) {                if(data.code == "200"){                    window.citys =data.data;                    var province = getTree(data.data);//[{id:'',name:''}]                    if(citys.length <1){                        $('#service_provice').html('<h2>无法获取城市数据请刷新页面重试或联系客服！</h2>')                        return false;                    }                    var prohtml='',cityhtml='';//省份                    for(var i in province){                        prohtml += '<a href="javascript:;"';                        if(i==0) prohtml+=' class="on"'                        prohtml += ' data-id="'+province[i].id+'">'+province[i].name+'</a>'                    }                    $('#service_provice').html(prohtml);                    getCitys(province[0]['id']);                }else{                    alert(data.msg);                }            });        }        //获取店家        function getserviceList(proid,city){            $.ajax({                url: getPath('www')+'/member/GetServiceList.htm',                type: 'GET',                dataType: 'json',                data: {'cityid': city,'provinceid':proid}            }).done(function(data) {                if(data.code == "200"){                    var html ='';                    if(data.data.length >0){                        html = template('serviceList',data);                    }else{                        html +='<p>您所选的城市没有服务网点信息请选择其他城市</p>';                    }                    $('#service_list').html(html)                    //分页                    var length = data.data.length;                    var pages = Math.ceil(length/5),                        pagehtml='';                    for(var i = 1;i <= pages;i++){                        pagehtml += '<a href="javascript:;"';                        if(i==1) pagehtml +=' class="on"';                         pagehtml +=' data-page="'+i+'">'+i+'</a>'                    }                    $('#service_page').html(pagehtml);                }else{                    alert('加载不出来了,重新刷新页面试试');                }            })        }        //获取城市树        function getTree(array){            var result =[];            //创建省            for(var i in array){                var temp = {'id':array[i].provinceId,'name':array[i].provinceName};                for(var k in result){                    if(result[k].id === temp.id){                        result.splice(k,1);                    }                }                result.push(temp);              }            return result;        }        //城市        function getCitys(proid){            if(citys == undefined){                $('#service_city').html('<p>暂无法获取城市数据，请刷新重试</p>');                return false;            }            var cityhtml='',m = 0;            for(var k in citys){//城市                if(citys[k]['provinceId'] == proid ){                    cityhtml += '<a href="javascript:;"';                    if(m==0) {                         cityhtml+=' class="on"';                        getserviceList(proid,citys[k]['cityId']);                    }                    m ++;                    cityhtml += 'data-proid="'+proid+'" data-id="'+citys[k]['cityId']+'">'+citys[k]['cityName']+'</a>'                }                                   }            //            $('#service_city').html(cityhtml);        }           });     // init map    function initmap(data){        // 百度地图API功能        map = new BMap.Map('allmap');        if(data.longitude !='' && data.latitude !='' && data.longitude <= 180 && data.latitude <= 90){//已有坐标            poi = new BMap.Point(data.longitude, data.latitude);            map.centerAndZoom(poi, 16);            map.enableScrollWheelZoom();             mapcommon(poi,data);        }else{//查询坐标            var myGeo = new BMap.Geocoder();            myGeo.getPoint(data.businessAddress,function(point){                if (point) {                     $.ajax({                            url:getPath('www')+'/member/updateLatAndLong.htm?ver='+(new Date()).getTime(),                            type:'post',                            data:{'longitude':point.lng,'latitude':point.lat,'id':data.id}                        });                    //console.log('longitude'+point.lng+',latitude'+point.lat);                    map.centerAndZoom(point, 16);                    map.enableScrollWheelZoom();                    mapcommon(point,data);                }            },$('#cityName').find('on').text());        }          }    function mapcommon(poi,data){            var content = '<div style="margin:0;line-height:25px;padding:2px;">' +            '<img src="http://res.qiku.com/images/index/wap_logo.png" alt="" style="width: 80px;height: 47px;margin-top: 20px;float:right;zoom:1;overflow:hidden;margin-left:3px;"/><div>' +            data.businessAddress + '<br/>电话：' + data.servicePhone +'</div></div>';        //创建检索信息窗口对象        var searchInfoWindow = null;        searchInfoWindow = new BMapLib.SearchInfoWindow(map, content, {            title: data.netName,      //标题            width: 290,             //宽度            height: 'auto',              //高度            panel: "panel",         //检索结果面板            enableAutoPan: true,     //自动平移            searchTypes: [                BMAPLIB_TAB_SEARCH,   //周边检索                BMAPLIB_TAB_TO_HERE,  //到这里去                BMAPLIB_TAB_FROM_HERE //从这里出发            ]        });        var marker = new BMap.Marker(poi); //创建marker对象        marker.enableDragging(); //marker可拖拽        searchInfoWindow.open(marker);        marker.addEventListener("click", function (e) {            searchInfoWindow.open(marker);        })        map.addOverlay(marker); //在地图中添加marker    }    var map = null;    var poi = null;    mapZoom = function () {        var zoom = map.getZoom();        map.setZoom(++zoom);    }    mapShrink = function () {        var zoom = map.getZoom();        map.setZoom(--zoom);    }    mapLocate = function () {        map.centerAndZoom(poi, 16);    }</script>{% endblock %}